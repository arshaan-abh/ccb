#!/bin/bash
git pull

# Build the project
rm -rf dist
sleep 2
if ! npm run build; then
  echo "Build failed, exiting..."
  exit 1
fi

echo "build done"

# Get NAME from first arg or prompt
if [ -n "$1" ]; then
  NAME="$1"
else
  read -p "NAME( no white spaces): " NAME
fi

if [ -z "$NAME" ]; then
  echo "NAME is required"
  exit 1
fi

ENV_FILE=".env.$NAME"
LOG_DIR="logs"
LOG_TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
LOG_FILE="$LOG_DIR/${NAME}-${LOG_TIMESTAMP}.log"

# Create logs directory if missing
mkdir -p "$LOG_DIR"

# Handle .env file existence
if [ -f "$ENV_FILE" ]; then
  echo "$ENV_FILE already exists. Content:"
  echo "----------------------------------------"
  cat "$ENV_FILE"
  echo "----------------------------------------"
  read -p "Do you want to override it? (y/N): " CONFIRM
  case "$CONFIRM" in
    [yY][eE][sS]|[yY])
      echo "Overriding $ENV_FILE..."
      force_prompt=true
      ;;
    *)
      echo "Skipping creation."
      echo ""
      echo "Continuing with existing env file..."
      goto_env_ready=true
      ;;
  esac
fi

if [ "$goto_env_ready" != true ]; then
  if [ "$force_prompt" = true ]; then
    BOT_TOKEN=""
    CHANNEL_ID=""
    API_KEY=""
    API_SECRET=""
    INVITE_LINK=""
    DEFAULT_THRESHOLD=""
    SYNC_INTERVAL_MINUTES=""
    WARNING_INTERVAL_MINUTES=""
    KICK_AFTER_WARNING_MINUTES=""
    INACTIVITY_THRESHOLD_MINUTES=""
    INACTIVITY_WARNING_INTERVAL_MINUTES=""
    SUPER_ADMIN_IDS=""
    ADMIN_IDS=""
  fi

  # Prompt for required inputs with validation
  while [ -z "$BOT_TOKEN" ]; do
    read -p "BOT_TOKEN: " BOT_TOKEN
    [ -z "$BOT_TOKEN" ] && echo "BOT_TOKEN is required"
  done

  while [ -z "$CHANNEL_ID" ]; do
    read -p "CHANNEL_ID: " CHANNEL_ID
    [ -z "$CHANNEL_ID" ] && echo "CHANNEL_ID is required"
  done

  while [ -z "$API_KEY" ]; do
    read -p "API_KEY: " API_KEY
    [ -z "$API_KEY" ] && echo "API_KEY is required"
  done

  while [ -z "$API_SECRET" ]; do
    read -p "API_SECRET: " API_SECRET
    [ -z "$API_SECRET" ] && echo "API_SECRET is required"
  done

  while [ -z "$INVITE_LINK" ]; do
    read -p "INVITE_LINK: " INVITE_LINK
    [ -z "$INVITE_LINK" ] && echo "INVITE_LINK is required"
  done

  while [ -z "$DEFAULT_THRESHOLD" ]; do
    read -p "DEFAULT_THRESHOLD: " DEFAULT_THRESHOLD
    [ -z "$DEFAULT_THRESHOLD" ] && echo "DEFAULT_THRESHOLD is required"
  done

  while [ -z "$SYNC_INTERVAL_MINUTES" ]; do
    read -p "SYNC_INTERVAL_MINUTES: " SYNC_INTERVAL_MINUTES
    [ -z "$SYNC_INTERVAL_MINUTES" ] && echo "SYNC_INTERVAL_MINUTES is required"
  done

  if [ -z "$WARNING_INTERVAL_MINUTES" ]; then
    read -p "WARNING_INTERVAL_MINUTES (default 1440): " WARNING_INTERVAL_MINUTES
    [ -z "$WARNING_INTERVAL_MINUTES" ] && WARNING_INTERVAL_MINUTES=1440
  fi

  if [ -z "$KICK_AFTER_WARNING_MINUTES" ]; then
    read -p "KICK_AFTER_WARNING_MINUTES (default 1440): " KICK_AFTER_WARNING_MINUTES
    [ -z "$KICK_AFTER_WARNING_MINUTES" ] && KICK_AFTER_WARNING_MINUTES=1440
  fi

  if [ -z "$INACTIVITY_THRESHOLD_MINUTES" ]; then
    read -p "INACTIVITY_THRESHOLD_MINUTES (default 1440): " INACTIVITY_THRESHOLD_MINUTES
    [ -z "$INACTIVITY_THRESHOLD_MINUTES" ] && INACTIVITY_THRESHOLD_MINUTES=1440
  fi

  if [ -z "$INACTIVITY_WARNING_INTERVAL_MINUTES" ]; then
    read -p "INACTIVITY_WARNING_INTERVAL_MINUTES (default 1440): " INACTIVITY_WARNING_INTERVAL_MINUTES
    [ -z "$INACTIVITY_WARNING_INTERVAL_MINUTES" ] && INACTIVITY_WARNING_INTERVAL_MINUTES=1440
  fi

  if [ -z "$SUPER_ADMIN_IDS" ]; then
    read -p "SUPER_ADMIN_IDS (e.g., [1,2,3]): " SUPER_ADMIN_IDS
    [ -z "$SUPER_ADMIN_IDS" ] && SUPER_ADMIN_IDS="[]"
  fi

  while [ -z "$ADMIN_IDS" ]; do
    read -p "ADMIN_IDS (e.g., [1,2,3]): " ADMIN_IDS
    [ -z "$ADMIN_IDS" ] && echo "ADMIN_IDS is required"
  done

  cat > "$ENV_FILE" <<EOF
NAME=$NAME
BOT_TOKEN=$BOT_TOKEN
CHANNEL_ID=$CHANNEL_ID
API_KEY=$API_KEY
API_SECRET=$API_SECRET
INVITE_LINK=$INVITE_LINK
DEFAULT_THRESHOLD=$DEFAULT_THRESHOLD
SYNC_INTERVAL_MINUTES=$SYNC_INTERVAL_MINUTES
WARNING_INTERVAL_MINUTES=$WARNING_INTERVAL_MINUTES
KICK_AFTER_WARNING_MINUTES=$KICK_AFTER_WARNING_MINUTES
INACTIVITY_THRESHOLD_MINUTES=$INACTIVITY_THRESHOLD_MINUTES
INACTIVITY_WARNING_INTERVAL_MINUTES=$INACTIVITY_WARNING_INTERVAL_MINUTES
SUPER_ADMIN_IDS=$SUPER_ADMIN_IDS
ADMIN_IDS=$ADMIN_IDS
EOF

  echo "Created $ENV_FILE"
  chmod 600 "$ENV_FILE"
fi

# Check if tmux is available
if ! command -v tmux &> /dev/null; then
  echo "tmux is not installed"
  exit 1
fi

# Kill existing session if it exists
if tmux has-session -t "$NAME" 2>/dev/null; then
  echo "Killing existing session '$NAME'..."
  tmux kill-session -t "$NAME"
fi

# Start new detached tmux session with output logged
echo "Starting tmux session '$NAME'..."
tmux new-session -d -s "$NAME" "export \$(xargs < $ENV_FILE); npm run start 2>&1 | tee $LOG_FILE; echo 'Process exited. Check logs and retry with same name if needed.' | tee -a $LOG_FILE"

echo "Tmux session '$NAME' started and detached."
echo "Logs are being written to $LOG_FILE"
echo ""
echo "To monitor: tmux attach -t $NAME"
echo "To view logs: tail -f $LOG_FILE"
echo "To stop:      tmux kill-session -t $NAME"
echo ""
echo "If the process exits with problems, retry with: $0 $NAME"
